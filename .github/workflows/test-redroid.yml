name: Test Redroid Full Stack

on:
  workflow_dispatch:

jobs:
  test-android:
    runs-on: ubuntu-latest
    
    steps:
      - name: Start Redroid
        run: |
          docker run -d --privileged \
            --name redroid \
            -p 5555:5555 \
            redroid/redroid:11.0.0-latest
          
          echo "Waiting for Android to boot..."
          sleep 30
          
      - name: Install ADB
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y android-tools-adb
          
      - name: Connect to Android
        run: |
          adb connect localhost:5555
          sleep 5
          adb devices
          
      - name: Test Android Shell
        run: |
          echo "=== Testing ADB connection ==="
          adb shell getprop ro.build.version.release
          adb shell pm list packages | head -5
          adb shell settings get secure android_id
          
      - name: Show logs if failed
        if: failure()
        run: |
          docker logs redroid
